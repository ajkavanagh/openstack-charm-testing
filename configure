#!/bin/bash

set -ex

# Add extra port to quantum-gateway and configure charm to use it
source ~/novarc
./bin/post-deploy-config

# Configure neutron networking on serverstack
source novarc
./bin/quantum-ext-net -g 10.5.0.1 -c 10.5.0.0/16 -f 10.5.100.0:10.5.200.25 ext_net

# Load an image for testing
glance image-create --name="precise" --is-public=true \
    --container-format=bare --disk-format=qcow2 < ~/images/precise-server-cloudimg-amd64-disk1.img
glance image-create --name="cirros" --is-public=trus \
    --container-format=bare --disk-format=qcow2 < ~/images/cirros-0.3.1-x86_64-disk.img

keystone tenant-create --name demo
keystone user-create --name demo --tenant demo --pass pass --enabled true --email demo@dev.null
keystone tenant-create --name alt_demo
keystone user-create --name alt_demo --tenant alt_demo --pass secret --enabled true --email alt_demo@dev.null

image_id=$(glance image-list | grep cirros | awk '{ print $2 }')
image_alt_id=$(glance image-list | grep precise | awk '{ print $2 }')
ext_net=$(neutron net-list | grep ext_net | awk '{ print $2 }')
router=$(neutron router-list | grep provider-router | awk '{ print $2}')
keystone=$(juju-deployer -f keystone)
dashboard=$(juju-deployer -f openstack-dashboard)

sed -e "s/__IMAGE_ID__/$image_id/g" -e "s/__IMAGE_ALT_ID__/$image_alt_id/g" \
    -e "s/__DASHBOARD__/$dashboard/g" -e "s/__KEYSTONE__/$keystone/g" \
    -e "s/__EXT_NET__/$ext_net/g" -e "s/__ROUTER__/$router/g" tempest.conf.template > tempest.conf

[ -d tempest ] || git clone https://github.com/openstack/tempest
cp tempest.conf tempest/etc
